<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TV DISPLAY - LIVE SCORE</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

    <style>
        :root { 
            --primary-start: #222222; --primary-end: #111111; --live-neon: #76FF03; --bg-color: #000000; --text-color: #fff;
            --title-color: #fff; --sub-color: #ffeb3b; --tag-color: #ffffff; --card-radius: 20px; --font-main: 'Montserrat', sans-serif;
            --logo-size: 1; --logo-opacity: 1; --logo-x: 0px; --logo-y: 0px; --title-size: 1; --sub-size: 1;
        }
        
        body { font-family: var(--font-main); background-color: var(--bg-color); margin: 0; padding: 0; color: var(--text-color); overflow: hidden; display: flex; flex-direction: column; height: 100vh; user-select: none; }
        
        /* ðŸ’¡ HEADER TV DIBUAT SANGAT TIPIS (1 BARIS) AGAR KARTU SKOR LEGA ðŸ’¡ */
        .header-wrapper { display: flex; flex-direction: row; align-items: center; justify-content: space-between; background: linear-gradient(135deg, var(--primary-start), var(--primary-end)); padding: 1vh 3vw; border-bottom: 3px solid rgba(255,255,255,0.1); box-shadow: 0 5px 15px rgba(0,0,0,0.5); flex-shrink: 0; height: 6vh; }
        
        .header-content { display: flex; align-items: center; gap: 2vw; }
        .header-title { margin: 0; font-size: calc(1.5vw * var(--title-size)); font-weight: 900; letter-spacing: 2px; text-transform: uppercase; color: var(--title-color); text-shadow: 0 4px 10px rgba(0,0,0,0.5); white-space: nowrap; } 
        .header-sub { display: none; /* ðŸ’¡ SUB-JUDUL DIHILANGKAN DI TV */ } 
        .header-badge { padding: 0.5vh 1.5vw; border-radius: 30px; background: rgba(255,255,255,0.2); font-size: 1vw; font-weight: 800; color: var(--tag-color); border: 1px solid rgba(255,255,255,0.2); text-transform: uppercase; letter-spacing: 1px; white-space: nowrap;}
        
        .logo-classic { width: 4vw; max-height: 5vh; object-fit: contain; transform: translate(var(--logo-x), var(--logo-y)) scale(var(--logo-size)); opacity: var(--logo-opacity); }
        .logo-watermark { position: absolute; top: 50%; left: 50%; width: 10vw; height: auto; transform: translate(calc(-50% + var(--logo-x)), calc(-50% + var(--logo-y))) scale(var(--logo-size)); opacity: var(--logo-opacity); z-index: 1; pointer-events: none; }

        /* ðŸ“º TV GRID SYSTEM (AUTO-SCALE) */
        #tv-grid { flex: 1; padding: 2vh 2vw; display: grid; gap: 2vw; align-content: center; justify-content: center; width: 100%; box-sizing: border-box; }
        #tv-grid.grid-1 { grid-template-columns: 1fr; grid-template-rows: 1fr; padding: 5vh 10vw;}
        #tv-grid.grid-2 { grid-template-columns: 1fr 1fr; grid-template-rows: 1fr; }
        #tv-grid.grid-3 { grid-template-columns: repeat(3, 1fr); grid-template-rows: 1fr; }
        #tv-grid.grid-4 { grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; }
        #tv-grid.grid-5, #tv-grid.grid-6 { grid-template-columns: 1fr 1fr 1fr; grid-template-rows: 1fr 1fr; }
        #tv-grid.grid-many { grid-template-columns: repeat(4, 1fr); grid-auto-rows: 1fr; }

        /* ðŸ’¡ PERBAIKAN PADDING & FONT AGAR TIDAK TERPOTONG ðŸ’¡ */
        .match-card { display: flex; flex-direction: column; justify-content: space-between; padding: 1.5vw; border-radius: var(--card-radius); height: 100%; box-sizing: border-box; transition: all 0.5s; position: relative; }
        
        .meta-text { font-size: 1vw; font-weight: 900; text-transform: uppercase; opacity: 0.9; }
        .court-badge { padding: 0.5vw 1vw; border-radius: 8px; font-size: 1.2vw; font-weight: 900; text-transform: uppercase; letter-spacing: 1px; display: inline-block; box-shadow: 0 5px 15px rgba(0,0,0,0.2);}
        
        .team { flex: 1; font-size: 1.6vw; font-weight: 800; line-height: 1.2; display: flex; align-items: center; width: 100%; word-break: break-word; }
        
        .score-pill { background: linear-gradient(135deg, var(--primary-start), var(--primary-end)); color: white; padding: 1vw; border-radius: 15px; font-size: 2vw; font-weight: 900; min-width: 10vw; max-width: 40%; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3); margin: 0 1.5vw; display: flex; flex-direction: column; align-items: center; justify-content: center; line-height: 1.1; border: 2px solid rgba(255,255,255,0.1);}
        
        @keyframes pulse-live-card { 0% { box-shadow: 0 0 5px var(--live-neon); transform: scale(1); border-color: transparent;} 100% { box-shadow: 0 0 20px var(--live-neon); transform: scale(1.02); border-color: var(--live-neon); } }
        .match-card.is-live { border: 3px solid var(--live-neon); animation: pulse-live-card 2s infinite alternate ease-in-out; z-index: 20; }
        
        .live-tag { color: #fff; background: var(--primary-start); font-weight: 900; font-size: 0.9vw; display: flex; align-items: center; gap: 0.5vw; padding: 0.4vw 0.8vw; border-radius: 8px; letter-spacing: 1px; box-shadow: 0 4px 10px rgba(0,0,0,0.3);}
        
        @keyframes blinker-live { 0% { opacity: 0.2; } 100% { opacity: 1; box-shadow: 0 0 15px var(--live-neon); } }
        .dot-live { display: inline-block; width: 0.8vw; height: 0.8vw; background-color: var(--live-neon) !important; border-radius: 50%; animation: blinker-live 0.8s infinite alternate; }
        .neon-dot { display: inline-block; width: 0.8vw; height: 0.8vw; background-color: var(--live-neon); border-radius: 50%; margin: 0 0.5vw; box-shadow: 0 0 10px var(--live-neon); vertical-align: middle; }

        /* MENGIMPOR 50 GAYA KARTU DARI CLIENT.HTML */
        .theme-classic-white { background: white; color: #333; } .theme-classic-white .meta-text { color: #C2185B; } .theme-classic-white .court-badge { background: #f5f5f5; color: #666; border: 1px solid #ddd; } 
        .theme-midnight-blue { background: #0d1b2a; color: #e0e1dd; border: 1px solid #1b263b; } .theme-midnight-blue .meta-text { color: #4CC9F0; } .theme-midnight-blue .court-badge { background: #1b263b; color: #4CC9F0; } 
        .theme-royal-gold { background: #fffcf5; color: #5d4037; border: 1px solid #daa520; } .theme-royal-gold .meta-text { color: #b8860b; } .theme-royal-gold .court-badge { background: linear-gradient(to bottom, #fff8dc, #f0e68c); color: #5d4037; border: 1px solid #daa520; }
        .theme-vampire-red { background: #1a0000; color: #ffcccc; border: 1px solid #4d0000; } .theme-vampire-red .meta-text { color: #FF5252; } .theme-vampire-red .court-badge { background: #4d0000; color: white; }
        .theme-ocean-breeze { background: #E1F5FE; color: #01579B; border: 1px solid #81d4fa; } .theme-ocean-breeze .meta-text { color: #0288d1; } .theme-ocean-breeze .court-badge { background: #0288D1; color: white; }
        .theme-neon-cyber { background: #050505; border: 1px solid #0ff; color: #0ff; } .theme-neon-cyber .meta-text { color: #fff; text-shadow: 0 0 5px #fff; } .theme-neon-cyber .court-badge { background: #002222; color: #fff; border: 1px solid #0ff; }
        .theme-emerald-city { background: #e8f5e9; color: #1b5e20; border: 1px solid #c8e6c9; } .theme-emerald-city .meta-text { color: #2e7d32; } .theme-emerald-city .court-badge { background: #4caf50; color: white; }
        .theme-sunset-glow { background: #fff3e0; color: #e65100; border: 1px solid #ffe0b2; } .theme-sunset-glow .meta-text { color: #f57c00; } .theme-sunset-glow .court-badge { background: #ff9800; color: white; }
        .theme-monochrome { background: #fafafa; color: #000; border: 2px solid #000; border-radius:0 !important; } .theme-monochrome .court-badge { background: #000; color: #fff; border-radius:0; }
        .theme-lavender { background: #f3e5f5; color: #4a148c; border: 1px solid #e1bee7; } .theme-lavender .court-badge { background: #ab47bc; color: white; }
        .theme-crimson { background: #ffebee; color: #b71c1c; border: 1px solid #ffcdd2; } .theme-crimson .court-badge { background: #e53935; color: white; }
        .theme-aqua-glass { background: rgba(224,247,250,0.7); backdrop-filter: blur(10px); color: #006064; border: 1px solid rgba(255,255,255,0.5); } .theme-aqua-glass .court-badge { background: #00bcd4; color: white; }
        .theme-forest-dark { background: #1b5e20; color: #e8f5e9; border: 1px solid #388e3c; } .theme-forest-dark .court-badge { background: #4caf50; color: white; }
        .theme-rose-gold { background: #fce4ec; color: #880e4f; border: 1px solid #f8bbd0; } .theme-rose-gold .meta-text { color: #d81b60; } .theme-rose-gold .court-badge { background: #f06292; color: white; }
        .theme-matrix-code { background: black; color: #00ff00; font-family: 'Courier Prime', monospace; } .theme-matrix-code .court-badge { border: 1px solid #00ff00; color: #00ff00; background: transparent; }
        .theme-obsidian { background: #0f0f0f; color: #f5f5f5; border: 1px solid #333; } .theme-obsidian .meta-text { color: #ffeb3b; } .theme-obsidian .court-badge { background: #222; color: #ffeb3b; }
        .theme-pearl { background: #fdfdfd; color: #444; border: 1px solid #e0e0e0; } .theme-pearl .meta-text { color: #880e4f; } .theme-pearl .court-badge { background: #eee; color: #880e4f; }
        .theme-ruby { background: #ffebee; color: #b71c1c; border: 1px solid #ff8a80; } .theme-ruby .court-badge { background: #b71c1c; color: white; }
        .theme-sapphire { background: #e3f2fd; color: #0d47a1; border: 1px solid #82b1ff; } .theme-sapphire .court-badge { background: #0d47a1; color: white; }
        .theme-amethyst { background: #f3e5f5; color: #4a148c; border: 1px solid #ea80fc; } .theme-amethyst .court-badge { background: #4a148c; color: white; }
        .theme-topaz { background: #fffde7; color: #e65100; border: 1px solid #ffd180; } .theme-topaz .court-badge { background: #e65100; color: white; }
        .theme-amber { background: #fff8e1; color: #f57f17; border: 1px solid #ffe57f; } .theme-amber .court-badge { background: #f57f17; color: white; }
        .theme-quartz { background: #fce4ec; color: #c2185b; border: 1px solid #ff80ab; } .theme-quartz .court-badge { background: #c2185b; color: white; }
        .theme-jade { background: #e8f5e9; color: #1b5e20; border: 1px solid #b9f6ca; } .theme-jade .court-badge { background: #1b5e20; color: white; }
        .theme-onyx { background: #212121; color: #fafafa; border: 1px solid #424242; } .theme-onyx .meta-text { color: #ff5252; } .theme-onyx .court-badge { background: #424242; color: #ff5252; }
        .theme-coral { background: #fbe9e7; color: #bf360c; border: 1px solid #ff9e80; } .theme-coral .court-badge { background: #bf360c; color: white; }
        .theme-turquoise { background: #e0f2f1; color: #004d40; border: 1px solid #a7ffeb; } .theme-turquoise .court-badge { background: #004d40; color: white; }
        .theme-malachite { background: #11270b; color: #a5d6a7; border: 1px solid #2e7d32; } .theme-malachite .meta-text { color: #69f0ae; } .theme-malachite .court-badge { background: #2e7d32; color: white; }
        .theme-opal { background: linear-gradient(120deg, #fdfbfb, #ebedee); color: #37474f; border: 1px solid #cfd8dc; } .theme-opal .court-badge { background: #b0bec5; color: #263238; }
        .theme-moonstone { background: #eceff1; color: #263238; border: 1px solid #b0bec5; } .theme-moonstone .court-badge { background: #78909c; color: white; }
        .theme-sunstone { background: #fff3e0; color: #e65100; border: 1px solid #ffcc80; } .theme-sunstone .court-badge { background: #e65100; color: white; }
        .theme-garnet { background: #3e2723; color: #ffccbc; border: 1px solid #5d4037; } .theme-garnet .meta-text { color: #ff5722; } .theme-garnet .court-badge { background: #5d4037; color: #ff5722; }
        .theme-peridot { background: #f1f8e9; color: #33691e; border: 1px solid #ccff90; } .theme-peridot .court-badge { background: #33691e; color: white; }
        .theme-citrine { background: #fff9c4; color: #f57f17; border: 1px solid #ffff8d; } .theme-citrine .court-badge { background: #f57f17; color: white; }
        .theme-spinel { background: #f8bbd0; color: #880e4f; border: 1px solid #ff80ab; } .theme-spinel .court-badge { background: #880e4f; color: white; }
        .theme-zircon { background: #e1f5fe; color: #01579b; border: 1px solid #80d8ff; } .theme-zircon .court-badge { background: #01579b; color: white; }
        .theme-tourmaline { background: linear-gradient(135deg, #f3e5f5, #e8f5e9); color: #333; border: 1px solid #ce93d8; } .theme-tourmaline .court-badge { background: #ab47bc; color: white; }
        .theme-beryl { background: #e0f7fa; color: #006064; border: 1px solid #84ffff; } .theme-beryl .court-badge { background: #006064; color: white; }
        .theme-alexandrite { background: #311b92; color: #b388ff; border: 1px solid #512da8; } .theme-alexandrite .meta-text { color: #ea80fc; } .theme-alexandrite .court-badge { background: #512da8; color: white; }
        .theme-tanzanite { background: #ede7f6; color: #4527a0; border: 1px solid #b388ff; } .theme-tanzanite .court-badge { background: #4527a0; color: white; }
        .theme-bloodstone { background: #1b1b1b; color: #ef9a9a; border: 1px solid #b71c1c; } .theme-bloodstone .court-badge { background: #b71c1c; color: white; }
        .theme-iolite { background: #283593; color: #c5cae9; border: 1px solid #3f51b5; } .theme-iolite .meta-text { color: #8c9eff; } .theme-iolite .court-badge { background: #3f51b5; color: white; }
        .theme-lapis { background: #1a237e; color: #e8eaf6; border: 1px solid #3949ab; } .theme-lapis .meta-text { color: #ffd740; } .theme-lapis .court-badge { background: #3949ab; color: white; }
        .theme-morganite { background: #ffebee; color: #c2185b; border: 1px solid #ff80ab; } .theme-morganite .court-badge { background: #c2185b; color: white; }
        .theme-kunzite { background: #fce4ec; color: #880e4f; border: 1px solid #ff4081; } .theme-kunzite .court-badge { background: #880e4f; color: white; }
        .theme-tsavorite { background: #e8f5e9; color: #1b5e20; border: 1px solid #00c853; } .theme-tsavorite .court-badge { background: #1b5e20; color: white; }
        .theme-rhodolite { background: #880e4f; color: #fce4ec; border: 1px solid #ad1457; } .theme-rhodolite .meta-text { color: #ff80ab; } .theme-rhodolite .court-badge { background: #ad1457; color: white; }
        .theme-spessartite { background: #bf360c; color: #fbe9e7; border: 1px solid #d84315; } .theme-spessartite .meta-text { color: #ff9e80; } .theme-spessartite .court-badge { background: #d84315; color: white; }
        .theme-demantoid { background: #33691e; color: #f1f8e9; border: 1px solid #558b2f; } .theme-demantoid .meta-text { color: #ccff90; } .theme-demantoid .court-badge { background: #558b2f; color: white; }
        .theme-padparadscha { background: #ffccbc; color: #bf360c; border: 1px solid #ff8a65; } .theme-padparadscha .court-badge { background: #bf360c; color: white; }

        .empty-state { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 3vw; color: rgba(255,255,255,0.3); font-weight: 900; text-transform: uppercase; letter-spacing: 5px; }
        
        /* ðŸ’¡ INFO FULLSCREEN TIPIS DI POJOK BAWAH ðŸ’¡ */
        .fs-hint { position: fixed; bottom: 10px; right: 15px; font-size: 0.8vw; color: rgba(255,255,255,0.3); font-weight: 600; pointer-events: none; }
    </style>
</head>
<body>

    <div class="header-wrapper">
        <div class="header-content">
            <h1 id="head-title" class="header-title">MEMUAT...</h1>
            <div id="head-tag" class="header-badge" style="display:none;"></div>
        </div>
        <img id="head-logo" class="header-logo logo-classic" style="display:none;">
    </div>
    
    <img id="head-logo-watermark" class="header-logo logo-watermark" style="display:none;">

    <div id="tv-grid">
        <div class="empty-state">MEMUAT LIVE SCORE...</div>
    </div>
    
    <div class="fs-hint">Klik 2x di layar untuk Fullscreen</div>

    <script>
        // ðŸ’¡ FUNGSI DOUBLE CLICK UNTUK FULLSCREEN OTOMATIS (MENGHILANGKAN TAB BROWSER)
        document.body.addEventListener('dblclick', () => {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => console.log("Gagal Fullscreen"));
            } else {
                document.exitFullscreen();
            }
        });

        const SUPABASE_URL = 'https://gubcvxiupehbdpigrdct.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_k1y6fNI2opEXhwqKMbGYcA__2nD0yT6';
        const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const urlParams = new URLSearchParams(window.location.search);
        let TOURNAMENT_ID = urlParams.get('id') || 'demo';
        
        let reqCourts = urlParams.get('courts'); 
        let targetCourts = reqCourts ? reqCourts.split(',').map(c => c.trim().toLowerCase()) : [];

        let matches = [];
        let cardPreset = 'classic-white';
        let hideServeGlobal = false;

        async function init() {
            const { data } = await db.from('partners').select('*').eq('tournament_id', TOURNAMENT_ID).maybeSingle();
            if (data) applyTheme(data); 
            await fetchMatches();
            subscribe();
        }

        function applyTheme(d) {
            const r = document.documentElement.style;
            r.setProperty('--font-main', d.font_family || 'Montserrat');
            r.setProperty('--primary-start', d.color_primary || '#222');
            r.setProperty('--primary-end', d.color_gradient_end || d.color_primary);
            r.setProperty('--live-neon', d.color_neon || '#76FF03');
            r.setProperty('--bg-color', d.color_bg || '#000000');
            document.body.style.backgroundColor = d.color_bg || '#000000';
            
            r.setProperty('--title-color', d.text_color_title || '#fff');
            r.setProperty('--sub-color', d.text_color_sub || '#ffeb3b');
            r.setProperty('--tag-color', d.text_color_tag || '#ffffff');
            r.setProperty('--title-size', d.title_size || '1');
            
            hideServeGlobal = (d.hide_serve === 'true');

            let rawLogoMode = d.logo_mode || 'watermark|||GD';
            let lmParts = rawLogoMode.split('|||');
            let lMode = lmParts[0];

            const tagEl = document.getElementById('head-tag');
            if (d.tag_text && d.tag_text.trim() !== '') {
                tagEl.innerText = d.tag_text;
                tagEl.style.display = 'inline-block';
            } else {
                tagEl.style.display = 'none';
            }

            r.setProperty('--logo-size', d.logo_size || '1'); r.setProperty('--logo-opacity', d.logo_opacity || '1');
            r.setProperty('--logo-x', (d.logo_x || '0') + 'px'); r.setProperty('--logo-y', (d.logo_y || '0') + 'px');

            const imgClassic = document.getElementById('head-logo');
            const imgWatermark = document.getElementById('head-logo-watermark');
            
            imgClassic.style.display = 'none';
            imgWatermark.style.display = 'none';

            if(d.logo_url) { 
                if(lMode === 'classic') {
                    imgClassic.src = d.logo_url; imgClassic.style.display = 'block';
                } else {
                    imgWatermark.src = d.logo_url; imgWatermark.style.display = 'block';
                }
            } 

            cardPreset = d.card_preset || 'classic-white'; r.setProperty('--card-radius', (d.corner_radius || 15) + 'px');

            if(d.bg_image_url) { document.body.style.backgroundImage = `url('${d.bg_image_url}')`; document.body.style.backgroundSize = 'cover'; document.body.style.backgroundAttachment = 'fixed'; } 
            
            document.getElementById('head-title').innerText = d.event_name || "TOURNAMENT";

            if (matches.length > 0) renderTV();
        }

        async function fetchMatches() {
            const { data: mData } = await db.from('matches_pro').select('*').eq('tournament_id', TOURNAMENT_ID).eq('status', 'LIVE').order('created_at', {ascending: true});
            if(mData) { 
                mData.sort((a, b) => new Date(a.created_at) - new Date(b.created_at)); 
                matches = mData; 
                renderTV(); 
            }
        }

        function formatTeamName(teamString, serverState, isTeamA) {
            if(hideServeGlobal) return `<div style="text-align:${isTeamA?'left':'right'}">${teamString}</div>`; 
            const dotHTML = '<span class="neon-dot"></span>';
            if(!teamString.includes('/')) {
                let isServing = (serverState === (isTeamA ? 'a' : 'b') || serverState === teamString);
                return `<div style="text-align:${isTeamA?'left':'right'}">${isTeamA ? (isServing?dotHTML:'') + teamString : teamString + (isServing?dotHTML:'')}</div>`;
            }
            let players = teamString.split('/').map(x => x.trim());
            let isS1 = (serverState === players[0]); let isS2 = (serverState === players[1]);
            let ic1 = isS1 ? dotHTML : ''; let ic2 = isS2 ? dotHTML : '';
            if(isTeamA) { return `<div style="display:flex; flex-direction:column; align-items:flex-start; gap:0.5vh;"><div>${ic1}${players[0]}</div><div>${ic2}${players[1]}</div></div>`; } 
            else { return `<div style="display:flex; flex-direction:column; align-items:flex-end; gap:0.5vh; text-align:right;"><div>${players[0]}${ic1}</div><div>${players[1]}${ic2}</div></div>`; }
        }

        function renderTV() {
            const gridEl = document.getElementById('tv-grid');
            
            let liveMatches = matches;
            if (targetCourts.length > 0) {
                liveMatches = matches.filter(m => targetCourts.includes(String(m.court_name).trim().toLowerCase()));
            }

            if (liveMatches.length === 0) {
                gridEl.className = 'grid-1';
                let txt = targetCourts.length > 0 ? `TIDAK ADA PERTANDINGAN LIVE DI COURT TERPILIH` : `BELUM ADA PERTANDINGAN LIVE`;
                gridEl.innerHTML = `<div class="empty-state">${txt}</div>`;
                return;
            }

            gridEl.className = ''; 
            if (liveMatches.length === 1) gridEl.classList.add('grid-1');
            else if (liveMatches.length === 2) gridEl.classList.add('grid-2');
            else if (liveMatches.length === 3) gridEl.classList.add('grid-3');
            else if (liveMatches.length === 4) gridEl.classList.add('grid-4');
            else if (liveMatches.length <= 6) gridEl.classList.add('grid-6');
            else gridEl.classList.add('grid-many');

            gridEl.innerHTML = "";

            liveMatches.forEach(m => {
                let sets = []; let maxSet = m.current_set || 1;
                for(let i=1; i<=5; i++) {
                    let sa = parseInt(m[`set${i}_a`]) || 0; let sb = parseInt(m[`set${i}_b`]) || 0; let isCurr = ((m.current_set || 1) == i);
                    if (isCurr || sa > 0 || sb > 0 || (i === 1 && maxSet === 1)) {
                        if (isCurr) { sets.push(`<span style="color:var(--live-neon); text-shadow: 0 0 10px rgba(0,0,0,0.8); font-size:1.3em;">${sa}-${sb}</span>`); } 
                        else { sets.push(`<span>${sa}-${sb}</span>`); }
                    }
                }
                if(sets.length === 0) sets.push(`<span>0-0</span>`);
                let scoreStr = `<div style="display:flex; flex-wrap:wrap; justify-content:center; gap:0.8vw; align-items:center;">` + sets.join('<span style="opacity:0.3; font-size:0.8em;">â€¢</span>') + `</div>`;
                
                let smallPt = `<div style="font-size:1.2vw; margin-top:1vh; color:inherit; font-weight:900; letter-spacing:2px; background:rgba(0,0,0,0.2); padding:0.5vh 1.5vw; border-radius:10px;"><span style="color:var(--live-neon)">${m.points_a||0} - ${m.points_b||0}</span></div>`;

                let themeClass = 'theme-' + cardPreset;
                let metaHTML = `<span class="meta-text">${m.category} â€¢ ${m.round}</span>`;
                let timeInfo = '<div class="live-tag"><div class="dot-live"></div> LIVE</div>'; 

                let teamA_Formatted = formatTeamName(m.team_a, m.server, true);
                let teamB_Formatted = formatTeamName(m.team_b, m.server, false);

                gridEl.innerHTML += `
                <div class="match-card ${themeClass} is-live">
                    <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid rgba(0,0,0,0.1); padding-bottom:1vh; margin-bottom:1.5vh;">
                        ${metaHTML} ${timeInfo}
                    </div>
                    <div style="display:flex; align-items:center; justify-content:space-between; flex:1;">
                        <div class="team" style="justify-content:flex-start;">${teamA_Formatted}</div>
                        <div class="score-pill">${scoreStr}${smallPt}</div>
                        <div class="team" style="justify-content:flex-end;">${teamB_Formatted}</div>
                    </div>
                    <div style="text-align:center; margin-top:1.5vh;">
                        <span class="court-badge">${m.court_name}</span>
                    </div>
                </div>`;
            });
        }

        let fetchTimeout = null;
        function triggerFetch() { clearTimeout(fetchTimeout); fetchTimeout = setTimeout(() => { fetchMatches(); }, 500); }
        
        function subscribe() {
            db.channel('public:matches_pro').on('postgres_changes', {event:'*', schema:'public', table:'matches_pro', filter:`tournament_id=eq.${TOURNAMENT_ID}`}, ()=>triggerFetch()).subscribe();
            db.channel('public:partners').on('postgres_changes', {event:'UPDATE', schema:'public', table:'partners', filter:`tournament_id=eq.${TOURNAMENT_ID}`}, (p)=>applyTheme(p.new)).subscribe();
        }
        
        init();
    </script>
</body>
</html>