<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1a237e">
    <title>LIVE SCORE PRO</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Courier+Prime&family=Lato:wght@400;700&family=Montserrat:wght@400;600;700;800&family=Oswald:wght@400;700&family=Playfair+Display:wght@400;700&family=Poppins:wght@400;600;700;800&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

    <style>
        html, body { overflow-x: hidden; width: 100%; max-width: 100vw; }
        * { box-sizing: border-box; }

        :root { 
            --primary-start: #222222; --primary-end: #111111; --live-neon: #76FF03; --bg-color: #FDF2F5; --text-color: #333;
            --title-color: #fff; --sub-color: #ffeb3b; --tag-color: #ffffff; --card-radius: 15px; --font-main: 'Montserrat', sans-serif;
            --logo-size: 1; --logo-opacity: 1; --logo-x: 0px; --logo-y: 0px; --title-size: 1; --sub-size: 1;
        }
        
        body { font-family: var(--font-main); background-color: var(--bg-color); margin: 0; padding-bottom: 120px; color: var(--text-color); transition: all 0.5s ease; position: relative; scroll-behavior: smooth; }
        #bg-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; opacity: 0; pointer-events: none; z-index: -1; transition: opacity 0.5s ease; }
        
        .header-wrapper { display: flex; flex-direction: column; align-items: center; justify-content: center; background: linear-gradient(135deg, var(--primary-start), var(--primary-end)); padding: 25px 15px 30px 15px; text-align: center; color: white; border-bottom-left-radius: 30px; border-bottom-right-radius: 30px; position: relative; z-index: 10; overflow: hidden; box-shadow: 0 5px 20px rgba(0,0,0,0.2); min-height: 100px; }
        .logo-watermark { position: absolute; top: 50%; left: 50%; width: 120px; height: auto; transform: translate(calc(-50% + var(--logo-x)), calc(-50% + var(--logo-y))) scale(var(--logo-size)); opacity: var(--logo-opacity); z-index: 1; pointer-events: none; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3)); display: none; object-fit: contain; }
        .logo-classic { position: relative; width: 100px; height: auto; margin: 0 auto 10px auto; transform: translate(var(--logo-x), var(--logo-y)) scale(var(--logo-size)); opacity: var(--logo-opacity); z-index: 5; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3)); display: none; object-fit: contain; }
        .header-content { position: relative; z-index: 5; width: 100%; pointer-events: none; }
        .header-title { margin: 0; font-size: calc(26px * var(--title-size)); font-weight: 800; letter-spacing: 1px; text-transform: uppercase; color: var(--title-color); text-shadow: 0 2px 5px rgba(0,0,0,0.4); line-height: 1.1; } 
        .header-sub { font-size: calc(14px * var(--sub-size)); margin-top: 5px; font-weight: 600; color: var(--sub-color); text-shadow: 0 1px 3px rgba(0,0,0,0.4); } 
        
        .header-badge { padding: 5px 15px; border-radius: 20px; background: rgba(255,255,255,0.2); font-size: 12px; font-weight: 700; display: inline-block; margin-top: 10px; color: var(--tag-color); backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.1); text-shadow: 0 1px 3px rgba(0,0,0,0.3); letter-spacing: 0.5px;}

        .cat-scroll-wrapper { width: 100%; overflow-x: auto; white-space: nowrap; padding: 15px 12px 5px 12px; margin-bottom: 10px; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
        .cat-scroll-wrapper::-webkit-scrollbar { display: none; }
        .cat-pill { display: inline-flex; align-items: center; gap: 6px; padding: 8px 16px; background: rgba(0,0,0,0.05); color: var(--text-color); border-radius: 20px; font-size: 11px; font-weight: 700; margin-right: 8px; cursor: pointer; border: 1px solid rgba(0,0,0,0.1); transition: 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .cat-pill.active { background: linear-gradient(135deg, var(--primary-start), var(--primary-end)); color: white; border: none; box-shadow: 0 4px 10px rgba(0,0,0,0.2); transform: scale(1.05); }
        
        .container { max-width: 500px; margin: 0 auto; padding: 0 12px; position: relative; z-index: 5; }
        .hidden { display: none !important; }

        .match-card { margin-bottom: 12px; padding: 12px 15px; position: relative; transition: all 0.3s; border-radius: var(--card-radius); }
        .meta-text { font-size: 10px; font-weight: 800; text-transform: uppercase; opacity: 0.9; }
        .court-badge { padding: 3px 8px; border-radius: 6px; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; display: inline-block;}
        .team { flex: 1; font-size: 13px; color: inherit; line-height: 1.4; }
        
        .score-pill { background: linear-gradient(135deg, var(--primary-start), var(--primary-end)); color: white; padding: 8px 15px; border-radius: 12px; font-size: 16px; font-weight: 800; min-width: 60px; max-width: 60%; flex-shrink: 0; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.15); margin: 0 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; line-height: 1.2;}
        
        @keyframes pulse-live-card { 0% { box-shadow: 0 0 5px var(--live-neon); transform: scale(1); border-color: transparent;} 100% { box-shadow: 0 0 20px var(--live-neon); transform: scale(1.02); border-color: var(--live-neon); } }
        .match-card.is-live { border: 2px solid var(--live-neon); animation: pulse-live-card 1.5s infinite alternate ease-in-out; z-index: 20; }
        
        .live-tag { color: #fff; background: var(--primary-start); font-weight: 800; font-size: 9px; display: flex; align-items: center; gap: 4px; padding: 2px 8px; border-radius: 10px; }
        
        @keyframes blinker-live { 0% { opacity: 0.2; box-shadow: none; } 100% { opacity: 1; box-shadow: 0 0 8px var(--live-neon); } }
        .dot-live { display: inline-block; width: 6px; height: 6px; background-color: var(--live-neon) !important; border-radius: 50%; animation: blinker-live 0.8s infinite alternate; }
        
        .neon-dot { display: inline-block; width: 6px; height: 6px; background-color: var(--live-neon); border-radius: 50%; margin: 0 6px; box-shadow: 0 0 6px var(--live-neon); animation: pulse-dot 1s infinite alternate; vertical-align: middle; }
        @keyframes pulse-dot { 0% { transform: scale(0.8); opacity: 0.4; } 100% { transform: scale(1.4); opacity: 1; box-shadow: 0 0 10px var(--live-neon); } }

        .skeleton { background: #eee; background: linear-gradient(110deg, #ececec 8%, #f5f5f5 18%, #ececec 33%); border-radius: 5px; background-size: 200% 100%; animation: 1.5s shine linear infinite; }
        .skel-card { width: 100%; height: 100px; border-radius: var(--card-radius); margin-bottom: 12px; }
        @keyframes shine { to { background-position-x: -200%; } }

        .nav { position: fixed; bottom: 0; width: 100%; background: white; border-top-left-radius: 20px; border-top-right-radius: 20px; display: flex; padding: 12px 0; z-index: 100; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); }
        .nav-btn { flex: 1; text-align: center; font-size: 10px; color: #ccc; font-weight: 600; cursor:pointer; }
        .nav-btn.active { color: var(--primary-start); font-weight: 800; }
        
        /* THEMES */
        .theme-classic-white { background: white; color: #333; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border: 1px solid #eee; } .theme-classic-white .meta-text { color: #C2185B; } .theme-classic-white .court-badge { background: #f5f5f5; color: #666; border: 1px solid #ddd; } 
        .theme-midnight-blue { background: #0d1b2a; color: #e0e1dd; border: 1px solid #1b263b; } .theme-midnight-blue .meta-text { color: #4CC9F0; } .theme-midnight-blue .court-badge { background: #1b263b; color: #4CC9F0; } 
        .theme-royal-gold { background: #fffcf5; color: #5d4037; border: 1px solid #daa520; } .theme-royal-gold .meta-text { color: #b8860b; } .theme-royal-gold .court-badge { background: linear-gradient(to bottom, #fff8dc, #f0e68c); color: #5d4037; border: 1px solid #daa520; }
        .theme-vampire-red { background: #1a0000; color: #ffcccc; border: 1px solid #4d0000; box-shadow: 0 0 10px rgba(100,0,0,0.2); } .theme-vampire-red .meta-text { color: #FF5252; } .theme-vampire-red .court-badge { background: #4d0000; color: white; }
        .theme-ocean-breeze { background: #E1F5FE; color: #01579B; border: 1px solid #81d4fa; } .theme-ocean-breeze .meta-text { color: #0288d1; } .theme-ocean-breeze .court-badge { background: #0288D1; color: white; }
        .theme-neon-cyber { background: #050505; border: 1px solid #0ff; color: #0ff; } .theme-neon-cyber .meta-text { color: #fff; text-shadow: 0 0 5px #fff; } .theme-neon-cyber .court-badge { background: #002222; color: #fff; border: 1px solid #0ff; }
        .theme-emerald-city { background: #e8f5e9; color: #1b5e20; border: 1px solid #c8e6c9; } .theme-emerald-city .meta-text { color: #2e7d32; } .theme-emerald-city .court-badge { background: #4caf50; color: white; }
        .theme-sunset-glow { background: #fff3e0; color: #e65100; border: 1px solid #ffe0b2; } .theme-sunset-glow .meta-text { color: #f57c00; } .theme-sunset-glow .court-badge { background: #ff9800; color: white; }
        .theme-monochrome { background: #fafafa; color: #000; border: 2px solid #000; border-radius:0 !important; } .theme-monochrome .court-badge { background: #000; color: #fff; border-radius:0; }
        .theme-lavender { background: #f3e5f5; color: #4a148c; border: 1px solid #e1bee7; } .theme-lavender .court-badge { background: #ab47bc; color: white; }
        .theme-crimson { background: #ffebee; color: #b71c1c; border: 1px solid #ffcdd2; } .theme-crimson .court-badge { background: #e53935; color: white; }
        .theme-aqua-glass { background: rgba(224,247,250,0.7); backdrop-filter: blur(10px); color: #006064; border: 1px solid rgba(255,255,255,0.5); } .theme-aqua-glass .court-badge { background: #00bcd4; color: white; }
        .theme-forest-dark { background: #1b5e20; color: #e8f5e9; border: 1px solid #388e3c; } .theme-forest-dark .court-badge { background: #4caf50; color: white; }
        .theme-rose-gold { background: #fce4ec; color: #880e4f; border: 1px solid #f8bbd0; } .theme-rose-gold .meta-text { color: #d81b60; } .theme-rose-gold .court-badge { background: #f06292; color: white; }
        .theme-matrix-code { background: black; color: #00ff00; border: 1px solid #003300; font-family: 'Courier Prime', monospace; } .theme-matrix-code .court-badge { border: 1px solid #00ff00; color: #00ff00; background: transparent; }
        .theme-obsidian { background: #0f0f0f; color: #f5f5f5; border: 1px solid #333; } .theme-obsidian .meta-text { color: #ffeb3b; } .theme-obsidian .court-badge { background: #222; color: #ffeb3b; }
        .theme-pearl { background: #fdfdfd; color: #444; border: 1px solid #e0e0e0; } .theme-pearl .meta-text { color: #880e4f; } .theme-pearl .court-badge { background: #eee; color: #880e4f; }
        .theme-ruby { background: #ffebee; color: #b71c1c; border: 1px solid #ff8a80; } .theme-ruby .court-badge { background: #b71c1c; color: white; }
        .theme-sapphire { background: #e3f2fd; color: #0d47a1; border: 1px solid #82b1ff; } .theme-sapphire .court-badge { background: #0d47a1; color: white; }
        .theme-amethyst { background: #f3e5f5; color: #4a148c; border: 1px solid #ea80fc; } .theme-amethyst .court-badge { background: #4a148c; color: white; }
        .theme-topaz { background: #fffde7; color: #e65100; border: 1px solid #ffd180; } .theme-topaz .court-badge { background: #e65100; color: white; }
        .theme-amber { background: #fff8e1; color: #f57f17; border: 1px solid #ffe57f; } .theme-amber .court-badge { background: #f57f17; color: white; }
        .theme-quartz { background: #fce4ec; color: #c2185b; border: 1px solid #ff80ab; } .theme-quartz .court-badge { background: #c2185b; color: white; }
        .theme-jade { background: #e8f5e9; color: #1b5e20; border: 1px solid #b9f6ca; } .theme-jade .court-badge { background: #1b5e20; color: white; }
        .theme-onyx { background: #212121; color: #fafafa; border: 1px solid #424242; } .theme-onyx .meta-text { color: #ff5252; } .theme-onyx .court-badge { background: #424242; color: #ff5252; }
        .theme-coral { background: #fbe9e7; color: #bf360c; border: 1px solid #ff9e80; } .theme-coral .court-badge { background: #bf360c; color: white; }
        .theme-turquoise { background: #e0f2f1; color: #004d40; border: 1px solid #a7ffeb; } .theme-turquoise .court-badge { background: #004d40; color: white; }
        .theme-malachite { background: #11270b; color: #a5d6a7; border: 1px solid #2e7d32; } .theme-malachite .meta-text { color: #69f0ae; } .theme-malachite .court-badge { background: #2e7d32; color: white; }
        .theme-opal { background: linear-gradient(120deg, #fdfbfb, #ebedee); color: #37474f; border: 1px solid #cfd8dc; } .theme-opal .court-badge { background: #b0bec5; color: #263238; }
        .theme-moonstone { background: #eceff1; color: #263238; border: 1px solid #b0bec5; } .theme-moonstone .court-badge { background: #78909c; color: white; }
        .theme-sunstone { background: #fff3e0; color: #e65100; border: 1px solid #ffcc80; } .theme-sunstone .court-badge { background: #e65100; color: white; }
        .theme-garnet { background: #3e2723; color: #ffccbc; border: 1px solid #5d4037; } .theme-garnet .meta-text { color: #ff5722; } .theme-garnet .court-badge { background: #5d4037; color: #ff5722; }
        .theme-peridot { background: #f1f8e9; color: #33691e; border: 1px solid #ccff90; } .theme-peridot .court-badge { background: #33691e; color: white; }
        .theme-citrine { background: #fff9c4; color: #f57f17; border: 1px solid #ffff8d; } .theme-citrine .court-badge { background: #f57f17; color: white; }
        .theme-spinel { background: #f8bbd0; color: #880e4f; border: 1px solid #ff80ab; } .theme-spinel .court-badge { background: #880e4f; color: white; }
        .theme-zircon { background: #e1f5fe; color: #01579b; border: 1px solid #80d8ff; } .theme-zircon .court-badge { background: #01579b; color: white; }
        .theme-tourmaline { background: linear-gradient(135deg, #f3e5f5, #e8f5e9); color: #333; border: 1px solid #ce93d8; } .theme-tourmaline .court-badge { background: #ab47bc; color: white; }
        .theme-beryl { background: #e0f7fa; color: #006064; border: 1px solid #84ffff; } .theme-beryl .court-badge { background: #006064; color: white; }
        .theme-alexandrite { background: #311b92; color: #b388ff; border: 1px solid #512da8; } .theme-alexandrite .meta-text { color: #ea80fc; } .theme-alexandrite .court-badge { background: #512da8; color: white; }
        .theme-tanzanite { background: #ede7f6; color: #4527a0; border: 1px solid #b388ff; } .theme-tanzanite .court-badge { background: #4527a0; color: white; }
        .theme-bloodstone { background: #1b1b1b; color: #ef9a9a; border: 1px solid #b71c1c; } .theme-bloodstone .court-badge { background: #b71c1c; color: white; }
        .theme-iolite { background: #283593; color: #c5cae9; border: 1px solid #3f51b5; } .theme-iolite .meta-text { color: #8c9eff; } .theme-iolite .court-badge { background: #3f51b5; color: white; }
        .theme-lapis { background: #1a237e; color: #e8eaf6; border: 1px solid #3949ab; } .theme-lapis .meta-text { color: #ffd740; } .theme-lapis .court-badge { background: #3949ab; color: white; }
        .theme-morganite { background: #ffebee; color: #c2185b; border: 1px solid #ff80ab; } .theme-morganite .court-badge { background: #c2185b; color: white; }
        .theme-kunzite { background: #fce4ec; color: #880e4f; border: 1px solid #ff4081; } .theme-kunzite .court-badge { background: #880e4f; color: white; }
        .theme-tsavorite { background: #e8f5e9; color: #1b5e20; border: 1px solid #00c853; } .theme-tsavorite .court-badge { background: #1b5e20; color: white; }
        .theme-rhodolite { background: #880e4f; color: #fce4ec; border: 1px solid #ad1457; } .theme-rhodolite .meta-text { color: #ff80ab; } .theme-rhodolite .court-badge { background: #ad1457; color: white; }
        .theme-spessartite { background: #bf360c; color: #fbe9e7; border: 1px solid #d84315; } .theme-spessartite .meta-text { color: #ff9e80; } .theme-spessartite .court-badge { background: #d84315; color: white; }
        .theme-demantoid { background: #33691e; color: #f1f8e9; border: 1px solid #558b2f; } .theme-demantoid .meta-text { color: #ccff90; } .theme-demantoid .court-badge { background: #558b2f; color: white; }
        .theme-padparadscha { background: #ffccbc; color: #bf360c; border: 1px solid #ff8a65; } .theme-padparadscha .court-badge { background: #bf360c; color: white; }

        body.tv-mode .header-wrapper { padding: 15px; min-height: auto; border-radius: 0; margin-bottom: 10px; }
        body.tv-mode .nav, body.tv-mode .cat-scroll-wrapper { display: none !important; }
        body.tv-mode { padding-bottom: 0; }
        body.tv-mode .container { max-width: 100%; display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; padding: 10px; }
        body.tv-mode .match-card { width: calc(50% - 30px); font-size: 1.3em; margin-bottom: 0; box-sizing: border-box; }
        body.tv-mode .score-pill { font-size: 30px; min-width: 100px; }
        
        body.obs-mode { background: #00ff00 !important; color: white !important; }
        body.obs-mode .header-wrapper, body.obs-mode .nav, body.obs-mode .cat-scroll-wrapper, body.obs-mode #bg-overlay { display: none !important; }
        body.obs-mode .match-card { background: rgba(0,0,0,0.85) !important; border: 2px solid rgba(255,255,255,0.2) !important; box-shadow: 0 10px 30px rgba(0,0,0,0.5) !important; width: 600px; margin: 20px auto; color: white !important; }
        body.obs-mode .team { color: white !important; font-size: 18px; }
        body.obs-mode .meta-text { color: #ffeb3b !important; }
    </style>
</head>
<body>

    <div id="loading-screen">Loading...</div>
    <div id="bg-overlay"></div>

    <div class="header-wrapper">
        <img id="head-logo" class="header-logo logo-watermark">
        <div id="head-text-wrapper" class="header-content">
            <h1 id="head-title" class="header-title">...</h1>
            <div id="head-sub" class="header-sub">...</div>
            <div id="head-tag" class="header-badge" style="display:none;"></div>
        </div>
    </div>

    <div class="cat-scroll-wrapper" id="cat-tabs"></div>

    <div id="view-jadwal" class="container">
        <div id="skeleton-box">
            <div class="skeleton skel-card"></div><div class="skeleton skel-card"></div><div class="skeleton skel-card"></div>
        </div>
        <div id="jadwal-content"></div>
    </div>
    <div id="view-klasemen" class="container hidden"><div id="klasemen-content"></div></div>
    
    <div id="view-bagan" class="container hidden" style="max-width: 100vw; padding: 0;"><div id="bagan-content"></div></div>
    
    <div id="view-peraturan" class="container hidden"><div class="match-card theme-classic-white"><h3 style="margin-top:0; color:var(--primary-start);">Peraturan</h3><div id="rules-text" style="white-space: pre-wrap; font-size:13px; line-height:1.6; color:#444;"></div></div></div>

    <div class="nav">
        <a class="nav-btn active" onclick="go('jadwal', this)">JADWAL</a>
        <a class="nav-btn" onclick="go('klasemen', this)">KLASEMEN</a>
        <a class="nav-btn" onclick="go('bagan', this)">BAGAN</a>
        <a class="nav-btn" onclick="go('peraturan', this)">ATURAN</a>
    </div>

    <script>
        const SUPABASE_URL = 'https://gubcvxiupehbdpigrdct.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_k1y6fNI2opEXhwqKMbGYcA__2nD0yT6';
        const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const urlParams = new URLSearchParams(window.location.search);
        let TOURNAMENT_ID = urlParams.get('id') || 'demo';
        
        let isTVMode = urlParams.get('tv') === 'live';
        let reqCourt = urlParams.get('court');
        let isOBSMode = urlParams.get('obs') === 'true';

        let matches = [];
        let cardPreset = 'classic-white';
        let hideServeGlobal = false;
        let currentCategory = 'SEMUA';

        window.klasemenFormat = 'GD'; 

        if(isOBSMode) document.body.classList.add('obs-mode');
        else if(isTVMode || reqCourt) document.body.classList.add('tv-mode');

        async function init() {
            const { data } = await db.from('partners').select('*').eq('tournament_id', TOURNAMENT_ID).maybeSingle();
            if (data) applyTheme(data); 
            await fetchMatches();
            document.getElementById('skeleton-box').style.display = 'none';
            document.getElementById('loading-screen').style.display = 'none';
            subscribe();
        }

        function applyTheme(d) {
            const r = document.documentElement.style;
            r.setProperty('--font-main', d.font_family || 'Montserrat');
            r.setProperty('--primary-start', d.color_primary || '#222');
            r.setProperty('--primary-end', d.color_gradient_end || d.color_primary);
            r.setProperty('--live-neon', d.color_neon || '#76FF03');
            r.setProperty('--bg-color', d.color_bg || '#FDF2F5');
            if(!isOBSMode) document.body.style.backgroundColor = d.color_bg || '#FDF2F5';
            
            r.setProperty('--title-color', d.text_color_title || '#fff');
            r.setProperty('--sub-color', d.text_color_sub || '#ffeb3b');
            r.setProperty('--tag-color', d.text_color_tag || '#ffffff');
            r.setProperty('--title-size', d.title_size || '1');
            r.setProperty('--sub-size', d.sub_size || '1');
            document.getElementById('head-text-wrapper').style.display = (d.hide_text === 'true') ? 'none' : 'block';
            hideServeGlobal = (d.hide_serve === 'true');

            let rawLogoMode = d.logo_mode || 'watermark|||GD';
            let lmParts = rawLogoMode.split('|||');
            let lMode = lmParts[0];
            window.klasemenFormat = lmParts[1] || 'GD';

            const tagEl = document.getElementById('head-tag');
            if (d.tag_text && d.tag_text.trim() !== '') {
                tagEl.innerText = d.tag_text;
                tagEl.style.display = 'inline-block';
            } else {
                tagEl.style.display = 'none';
            }

            r.setProperty('--logo-size', d.logo_size || '1'); r.setProperty('--logo-opacity', d.logo_opacity || '1');
            r.setProperty('--logo-x', (d.logo_x || '0') + 'px'); r.setProperty('--logo-y', (d.logo_y || '0') + 'px');

            const img = document.getElementById('head-logo');
            if(img && d.logo_url) { img.src = d.logo_url; img.style.display = 'block'; img.className = (lMode === 'classic') ? 'header-logo logo-classic' : 'header-logo logo-watermark'; } 
            else if(img) { img.style.display = 'none'; }

            cardPreset = d.card_preset || 'classic-white'; r.setProperty('--card-radius', (d.corner_radius || 15) + 'px');

            if(d.bg_image_url && !isOBSMode) { document.body.style.backgroundImage = `url('${d.bg_image_url}')`; document.body.style.backgroundSize = 'cover'; document.body.style.backgroundAttachment = 'fixed'; } 
            else { document.body.style.backgroundImage = 'none'; }
            
            if(document.getElementById('head-title')) document.getElementById('head-title').innerText = d.event_name || "TOURNAMENT";
            if(document.getElementById('head-sub')) document.getElementById('head-sub').innerText = d.event_subtitle || "";
            if(document.getElementById('rules-text')) document.getElementById('rules-text').innerHTML = d.rules_text || "-";

            if (matches.length > 0) processAndRender();
        }

        async function fetchMatches() {
            let query = db.from('matches_pro').select('*').eq('tournament_id', TOURNAMENT_ID);
            if(isTVMode) query = query.eq('status', 'LIVE');
            if(reqCourt) query = query.ilike('court_name', reqCourt).eq('status', 'LIVE');
            const { data: mData } = await query.order('created_at', {ascending: true});
            if(mData) { mData.sort((a, b) => new Date(a.created_at) - new Date(b.created_at)); matches = mData; processAndRender(); }
        }

        function processAndRender() { renderTabs(); renderAll(); }

        function renderTabs() {
            if(isTVMode || reqCourt || isOBSMode) return; 
            let cats = [...new Set(matches.map(m => m.category || 'UMUM'))].filter(c => c);
            const tabEl = document.getElementById('cat-tabs');
            let html = `<div class="cat-pill ${currentCategory==='SEMUA'?'active':''}" onclick="setCat('SEMUA')">SEMUA LAGA</div>`;
            cats.forEach(c => {
                let hasLive = matches.some(m => (m.category||'UMUM') === c && m.status === 'LIVE');
                let dot = hasLive ? '<span class="neon-dot" style="margin:0"></span>' : '';
                let act = currentCategory === c ? 'active' : '';
                html += `<div class="cat-pill ${act}" onclick="setCat('${c}')">${c} ${dot}</div>`;
            });
            tabEl.innerHTML = html;
        }

        function setCat(c) { currentCategory = c; processAndRender(); setTimeout(() => { document.querySelector('.is-live')?.scrollIntoView({behavior: 'smooth', block: 'center'}); }, 300); }

        function formatTeamName(teamString, serverState, isTeamA) {
            if(hideServeGlobal) return `<div style="font-weight: 800; line-height: 1.15; ${!isTeamA ? 'text-align:right;' : ''}">${teamString}</div>`; 
            const dotHTML = '<span class="neon-dot"></span>';
            if(!teamString.includes('/')) {
                let isServing = (serverState === (isTeamA ? 'a' : 'b') || serverState === teamString);
                return `<div style="font-weight: 800; line-height: 1.15; ${!isTeamA ? 'text-align:right;' : ''}">${isTeamA ? (isServing?dotHTML:'') + teamString : teamString + (isServing?dotHTML:'')}</div>`;
            }
            let players = teamString.split('/').map(x => x.trim());
            let isS1 = (serverState === players[0]); let isS2 = (serverState === players[1]);
            let ic1 = isS1 ? dotHTML : ''; let ic2 = isS2 ? dotHTML : '';
            if(isTeamA) { return `<div style="display:flex; flex-direction:column; align-items:flex-start; gap:8px;"><div style="font-weight: 800; line-height: 1.15;">${ic1}${players[0]}</div><div style="font-weight: 800; line-height: 1.15;">${ic2}${players[1]}</div></div>`; } 
            else { return `<div style="display:flex; flex-direction:column; align-items:flex-end; gap:8px; text-align:right;"><div style="font-weight: 800; line-height: 1.15;">${players[0]}${ic1}</div><div style="font-weight: 800; line-height: 1.15;">${players[1]}${ic2}</div></div>`; }
        }

        function createCardHTML(m) {
            let status = String(m.status||'').trim().toUpperCase();
            let isLive = status === 'LIVE'; let isDone = status === 'FINISHED'; let isPending = status === 'PENDING';
            let totalA = (parseInt(m.set1_a)||0)+(parseInt(m.set2_a)||0)+(parseInt(m.set3_a)||0)+(parseInt(m.set4_a)||0)+(parseInt(m.set5_a)||0);
            let totalB = (parseInt(m.set1_b)||0)+(parseInt(m.set2_b)||0)+(parseInt(m.set3_b)||0)+(parseInt(m.set4_b)||0)+(parseInt(m.set5_b)||0);
            
            let scoreStr = '';
            if (isPending && totalA === 0 && totalB === 0) { scoreStr = 'VS'; } 
            else {
                let sets = []; let maxSet = isLive ? (m.current_set || 1) : 5;
                for(let i=1; i<=5; i++) {
                    let sa = parseInt(m[`set${i}_a`]) || 0; let sb = parseInt(m[`set${i}_b`]) || 0; let isCurr = isLive && ((m.current_set || 1) == i);
                    if (isCurr || sa > 0 || sb > 0 || (i === 1 && maxSet === 1 && isLive)) {
                        if (isCurr) { sets.push(`<span style="color:var(--live-neon); text-shadow: 0 0 5px rgba(0,0,0,0.5); font-size:1.1em;">${sa}-${sb}</span>`); } 
                        else { sets.push(`<span>${sa}-${sb}</span>`); }
                    }
                }
                if(sets.length === 0) sets.push(`<span>0-0</span>`);
                scoreStr = `<div style="display:flex; flex-wrap:wrap; justify-content:center; gap:6px; align-items:center;">` + sets.join('<span style="opacity:0.3; font-size:0.8em;">‚Ä¢</span>') + `</div>`;
            }

            let scoreCls = (scoreStr === 'VS') ? 'score-pill empty' : 'score-pill';
            let smallPt = isLive ? `<div style="font-size:12px; margin-top:5px; color:inherit; font-weight:900; letter-spacing:1px; background:rgba(0,0,0,0.15); padding:2px 10px; border-radius:6px;"><span style="color:var(--live-neon)">${m.points_a||0} - ${m.points_b||0}</span></div>` : '';

            let themeClass = 'theme-' + cardPreset;
            let metaHTML = `<span class="meta-text">${m.category} ‚Ä¢ ${m.round}</span>`;
            
            let timeInfo = '';
            if (isLive) { timeInfo = '<div class="live-tag"><div class="dot-live"></div> LIVE</div>'; } 
            else if (isDone) { timeInfo = '<div style="font-weight:800; font-size:9px; background:rgba(100,100,100,0.1); padding:2px 8px; border-radius:10px; opacity:0.8;">üèÅ FT</div>'; } 
            else { timeInfo = `<span style="font-size:11px; font-weight:600; opacity:0.8;">${(m.date ? m.date + ' ‚Ä¢ ' : '') + (m.time || '')}</span>`; } 

            let centerHTML = scoreStr === 'VS' ? '<div class="vs-text">VS</div>' : `<div class="${scoreCls}">${scoreStr}${smallPt}</div>`;
            let teamA_Formatted = formatTeamName(m.team_a, m.server, true);
            let teamB_Formatted = formatTeamName(m.team_b, m.server, false);

            let styleTA = ''; let styleTB = '';
            if (isDone) { if (totalA > totalB) { styleTB = 'opacity: 0.3;'; } else if (totalB > totalA) { styleTA = 'opacity: 0.3;'; } else { styleTA = 'opacity: 0.8;'; styleTB = 'opacity: 0.8;'; } }
            
            return `<div class="match-card ${themeClass} ${isLive?'is-live':''}" style="${isDone ? 'opacity: 0.85;' : ''}">
                <div style="display:flex; justify-content:space-between; border-bottom:1px solid rgba(0,0,0,0.05); padding-bottom:5px; margin-bottom:8px;">${metaHTML} <div style="display:flex; gap:10px; align-items:center;">${timeInfo}</div></div>
                <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
                    <div class="team" style="text-align:left; ${styleTA}">${teamA_Formatted}</div>
                    ${centerHTML}
                    <div class="team" style="text-align:right; ${styleTB}">${teamB_Formatted}</div>
                </div>
                <div style="text-align:center; margin-top:8px;"><span class="court-badge">${m.court_name}</span></div>
            </div>`;
        }

        function renderKlasemen() {
            const el = document.getElementById('klasemen-content'); el.innerHTML = "";
            let groups = {};
            let filteredMatches = matches.filter(m => currentCategory === 'SEMUA' || (m.category||'UMUM') === currentCategory);
            
            filteredMatches.filter(m => m.round.toLowerCase().includes('grup')).forEach(m => {
                let g = (m.category||'UMUM') + ' - ' + m.round;
                if(!groups[g]) groups[g]={cat: m.category||'UMUM', round: m.round};
                [m.team_a, m.team_b].forEach(t=>{ if(!groups[g][t]) groups[g][t]={mp:0, w:0, l:0, gw:0, gl:0, gd:0}; });
                
                if(String(m.status||'').trim().toUpperCase() === 'FINISHED'){
                    let sA=groups[g][m.team_a], sB=groups[g][m.team_b];
                    sA.mp++; sB.mp++;
                    let tA = (parseInt(m.set1_a)||0)+(parseInt(m.set2_a)||0)+(parseInt(m.set3_a)||0)+(parseInt(m.set4_a)||0)+(parseInt(m.set5_a)||0);
                    let tB = (parseInt(m.set1_b)||0)+(parseInt(m.set2_b)||0)+(parseInt(m.set3_b)||0)+(parseInt(m.set4_b)||0)+(parseInt(m.set5_b)||0);
                    sA.gw+=tA; sA.gl+=tB; sB.gw+=tB; sB.gl+=tA; sA.gd+=(tA-tB); sB.gd+=(tB-tA);
                    if(tA>tB){sA.w++; sB.l++;} else {sB.w++; sA.l++;}
                }
            });

            Object.keys(groups).sort().forEach(g => {
                let isPct = (window.klasemenFormat === 'PCT');
                let headerLabel = isPct ? '%' : 'GD';

                let rows = Object.keys(groups[g]).filter(k=>k!=='cat'&&k!=='round').map(t=>({name:t, ...groups[g][t]}))
                    .map(t => {
                        if(isPct) {
                            let totalGames = t.gw + t.gl;
                            t.pct = totalGames > 0 ? ((t.gw / totalGames) * 100).toFixed(2) : 0;
                            t.sortVal = (t.w * 10000) + parseFloat(t.pct); 
                            t.displayVal = t.pct + '%';
                        } else {
                            t.sortVal = (t.w * 10000) + t.gd;
                            t.displayVal = t.gd;
                        }
                        return t;
                    })
                    .sort((a,b)=> b.sortVal - a.sortVal)
                    .map((t,i)=>`<tr ${i===0?'style="background:rgba(255,255,0,0.1)"':''}><td>${i+1}</td><td style="text-align:left; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${t.name}</td><td>${t.mp}</td><td>${t.w}</td><td>${t.l}</td><td>${t.displayVal}</td></tr>`).join('');
                
                el.innerHTML += `<div class="match-card theme-${cardPreset}" style="padding:0; overflow:hidden; max-width:500px; margin-left:auto; margin-right:auto;"><div style="padding:10px; font-weight:bold; border-bottom:1px solid rgba(0,0,0,0.1); display:flex; justify-content:space-between;"><span>${groups[g].cat}</span> <span style="color:var(--primary-start)">${groups[g].round}</span></div><table style="width:100%; border-collapse:collapse; font-size:11px; text-align:center; table-layout:fixed;"><thead><tr style="background:rgba(0,0,0,0.05);"><th style="width:25px;">#</th><th style="text-align:left; padding:8px; width:auto;">TIM</th><th style="width:30px;">MP</th><th style="width:30px;">W</th><th style="width:30px;">L</th><th style="width:55px;">${headerLabel}</th></tr></thead><tbody>${rows}</tbody></table></div>`;
            });
        }

        // üí° FUNGSI BARU: RENDER BAGAN (BRACKET TREE) üí°
        function renderBaganTree(baganMatches) {
            const elB = document.getElementById('bagan-content');
            if(baganMatches.length === 0) { elB.innerHTML = "<div style='text-align:center; padding:20px; opacity:0.5; font-weight:bold; width:100vw;'>BELUM ADA DATA BAGAN / GUGUR</div>"; return; }

            // Logika Pembobotan Round (Agar berurutan 16 -> 8 -> SF -> Final)
            let getWt = (r) => {
                let s = String(r).toLowerCase();
                if(s.includes('grand final') || (s.includes('final') && !s.includes('semi') && !s.includes('quarter') && !s.includes('perempat'))) return 100;
                if(s.includes('juara 3') || s.includes('third')) return 90;
                if(s.includes('semi') || s.includes('sf')) return 80;
                if(s.includes('quarter') || s.includes('perempat') || s.includes('qf') || s.includes('8')) return 70;
                if(s.includes('16')) return 60;
                if(s.includes('32')) return 50;
                return 10;
            };

            let rounds = {};
            baganMatches.forEach(m => {
                let r = (m.round || 'Knockout').toUpperCase();
                if(!rounds[r]) rounds[r] = [];
                rounds[r].push(m);
            });

            let sortedRounds = Object.keys(rounds).sort((a,b) => getWt(a) - getWt(b));

            // Kontainer Utama Bagan (Scroll Menyamping)
            let html = `<div style="display:flex; overflow-x:auto; padding:10px 15px 40px 15px; gap:35px; align-items:stretch; scrollbar-width:none;">`;
            
            sortedRounds.forEach((rName, i) => {
                let isLast = i === sortedRounds.length - 1;
                html += `<div style="display:flex; flex-direction:column; justify-content:space-around; min-width:220px; max-width:220px; gap:20px;">`;
                
                // Judul Round (Misal: QUARTER FINAL)
                html += `<div style="text-align:center; font-weight:900; font-size:12px; color:var(--primary-start); border-bottom:3px solid var(--live-neon); padding-bottom:5px;">${rName}</div>`;
                
                html += `<div style="display:flex; flex-direction:column; justify-content:space-around; flex:1; gap:20px;">`;
                rounds[rName].forEach(m => {
                    let isLive = String(m.status).toUpperCase() === 'LIVE';
                    let isDone = String(m.status).toUpperCase() === 'FINISHED';
                    let tA = (parseInt(m.set1_a)||0)+(parseInt(m.set2_a)||0)+(parseInt(m.set3_a)||0)+(parseInt(m.set4_a)||0)+(parseInt(m.set5_a)||0);
                    let tB = (parseInt(m.set1_b)||0)+(parseInt(m.set2_b)||0)+(parseInt(m.set3_b)||0)+(parseInt(m.set4_b)||0)+(parseInt(m.set5_b)||0);
                    let wA = isDone && tA > tB; let wB = isDone && tB > tA;
                    
                    let sA = isDone || isLive ? tA : '-'; let sB = isDone || isLive ? tB : '-';
                    if(isLive) { sA = `<span style="color:var(--live-neon)">${tA}</span>`; sB = `<span style="color:var(--live-neon)">${tB}</span>`; }
                    
                    // Singkat Nama Panjang
                    let fn = (n) => {
                        if(!n) return 'TBD';
                        if(!n.includes('/')) return n;
                        let p = n.split('/');
                        return p[0].trim().split(' ')[0] + ' / ' + (p[1]?p[1].trim().split(' ')[0]:'');
                    };
                    let nA = fn(m.team_a); let nB = fn(m.team_b);
                    
                    let liveB = isLive ? `<div style="position:absolute; top:-8px; right:5px; background:var(--live-neon); color:#000; font-size:9px; font-weight:900; padding:2px 6px; border-radius:4px; box-shadow:0 2px 5px rgba(0,0,0,0.3); z-index:5; animation:pulse-dot 1s infinite alternate;">LIVE</div>` : '';
                    let tCls = 'theme-' + cardPreset;
                    
                    html += `
                    <div style="position:relative; display:flex; align-items:center; width:100%;">
                        <div class="match-card ${tCls}" style="width:100%; padding:0; margin:0; border-radius:8px; position:relative; box-shadow:0 4px 10px rgba(0,0,0,0.1); border:1px solid rgba(0,0,0,0.05); ${isLive ? 'border:2px solid var(--live-neon);' : ''}">
                            ${liveB}
                            <div style="display:flex; justify-content:space-between; padding:10px 12px; border-bottom:1px solid rgba(0,0,0,0.05); background:rgba(0,0,0,0.02);">
                                <div style="font-size:11px; font-weight:${wA?'900':'600'}; opacity:${wA||!isDone?'1':'0.5'}; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:80%;">${nA}</div>
                                <div style="font-size:13px; font-weight:900;">${sA}</div>
                            </div>
                            <div style="display:flex; justify-content:space-between; padding:10px 12px;">
                                <div style="font-size:11px; font-weight:${wB?'900':'600'}; opacity:${wB||!isDone?'1':'0.5'}; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:80%;">${nB}</div>
                                <div style="font-size:13px; font-weight:900;">${sB}</div>
                            </div>
                        </div>
                        ${!isLast ? `<div style="position:absolute; right:-35px; top:50%; width:35px; height:2px; background:var(--primary-start); opacity:0.3; z-index:-1;"></div>` : ''}
                    </div>`;
                });
                html += `</div></div>`;
            });
            
            html += `</div>`;
            elB.innerHTML = html;
        }

        function renderAll() {
            const elJ = document.getElementById('jadwal-content'); elJ.innerHTML = "";
            let filteredMatches = matches.filter(m => currentCategory === 'SEMUA' || (m.category||'UMUM') === currentCategory);
            
            filteredMatches.filter(m => m.round.toLowerCase().includes('grup')).forEach(m => elJ.innerHTML += createCardHTML(m));
            
            // Render Bagan dengan Tampilan Pohon
            renderBaganTree(filteredMatches.filter(m => !m.round.toLowerCase().includes('grup')));
            renderKlasemen();
        }

        let fetchTimeout = null;
        function triggerFetch() { clearTimeout(fetchTimeout); fetchTimeout = setTimeout(() => { fetchMatches(); }, 500); }
        function subscribe() {
            db.channel('public:matches_pro').on('postgres_changes', {event:'*', schema:'public', table:'matches_pro', filter:`tournament_id=eq.${TOURNAMENT_ID}`}, ()=>triggerFetch()).subscribe();
            db.channel('public:partners').on('postgres_changes', {event:'UPDATE', schema:'public', table:'partners', filter:`tournament_id=eq.${TOURNAMENT_ID}`}, (p)=>applyTheme(p.new)).subscribe();
        }
        function go(id, btn) { document.querySelectorAll('.container').forEach(c=>c.classList.add('hidden')); document.getElementById('view-'+id).classList.remove('hidden'); document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); }
        init();
    </script>
</body>
</html>