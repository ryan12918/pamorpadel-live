<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="color-scheme" content="dark">
    <title>WASIT PRO V10.6</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
    
    <style>
        body { background: #121212; color: #fff; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; user-select: none; transition: 0.3s; }
        body.mode-tb { background: #2c0b0b; }
        .hidden { display: none !important; }

        .login-box { background: #1e1e1e; padding: 25px; border-radius: 12px; width: 100%; max-width: 320px; text-align: center; border: 1px solid #333; margin-top: 10vh; }
        .inp-login { width: 100%; padding: 12px; margin: 8px 0; background: #2c2c2c; border: 1px solid #444; color: white; border-radius: 6px; text-align: center; font-size: 16px; box-sizing: border-box; }
        .btn-login { width: 100%; padding: 12px; background: #007bff; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 10px; }

        .timer-bar { display: flex; gap: 10px; width: 100%; max-width: 500px; margin-bottom: 10px; }
        .t-box { flex: 1; background: #1e1e1e; border: 1px solid #333; border-radius: 8px; padding: 10px; text-align: center; display: flex; flex-direction: column; justify-content: space-between; }
        .t-lbl { font-size: 10px; color: #aaa; font-weight: bold; }
        .t-val { font-size: 24px; font-weight: 900; color: #fff; margin: 2px 0; font-variant-numeric: tabular-nums; }
        .t-val.clickable:active { transform: scale(0.95); opacity: 0.7; }
        .t-btn { background: #333; color: white; border: none; border-radius: 4px; padding: 5px 0; font-size: 10px; font-weight: bold; cursor: pointer; text-transform: uppercase; }

        .ctrl-bar { display: flex; justify-content: space-between; align-items: center; width: 100%; max-width: 500px; margin-bottom: 10px; gap: 5px; }
        .set-nav { display: flex; align-items: center; background: #000; padding: 5px 10px; border-radius: 8px; border: 1px solid #333; flex: 1; justify-content: space-between; }
        .btn-nav { background: #333; color: white; border: none; width: 35px; height: 35px; border-radius: 6px; font-weight: bold; cursor: pointer; }
        
        .mode-toggle { background: #2c2c2c; padding: 10px; border-radius: 8px; border: 1px solid #444; font-size: 10px; font-weight:bold; color: #aaa; cursor: pointer; display: flex; align-items: center; gap: 8px; }
        .mode-toggle.active { background: #e65100; color: white; border-color: #ff9800; }
        .ind-mode { width:12px; height:12px; background:#555; border-radius:50%; }

        .smart-alert { width: 100%; max-width: 500px; padding: 10px; text-align: center; font-weight: 900; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; border-radius: 6px; margin-bottom: 10px; animation: pulseAlert 1s infinite alternate; }
        @keyframes pulseAlert { 0% { transform: scale(0.98); opacity: 0.8; } 100% { transform: scale(1.02); opacity: 1; } }

        .arena { display: flex; width: 100%; max-width: 500px; gap: 10px; margin-bottom: 15px; }
        .side { flex: 1; padding: 12px; border-radius: 12px; display: flex; flex-direction: column; }
        .side.team-a { background: #0d1b2a; border: 2px solid #1b263b; }
        .side.team-b { background: #3e1f1f; border: 2px solid #5c2c2c; }

        .serve-box { background: rgba(0,0,0,0.4); border-radius: 8px; padding: 8px; margin-bottom: 15px; min-height: 85px;}
        .player-row { padding: 10px 8px; border-radius: 6px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border: 1px solid transparent; margin-bottom: 4px; background: rgba(255,255,255,0.05); font-size: 13px; font-weight: 600; transition: 0.2s;}
        .player-row.active { border-color: #ffd700; background: rgba(255, 215, 0, 0.15); font-weight: 800; color: #ffd700; }
        .ball-icon { display: none; font-size: 14px; }
        .player-row.active .ball-icon { display: block; }

        .score-display { text-align: center; margin-bottom: 15px; }
        .game-adj { display: flex; gap: 5px; justify-content: center; margin-bottom: 5px; }
        .game-adj button { background: rgba(255,255,255,0.1); border:none; color:white; width: 30px; height: 30px; border-radius: 4px; font-weight:bold; }
        .game-val { font-size: 36px; font-weight: 900; background: transparent; color: white; border: none; width: 50px; text-align: center; }
        .point-val { font-size: 48px; font-weight: 900; background: #000; color: #ffd700; border: 1px solid rgba(255,255,255,0.2); width: 100%; text-align: center; border-radius: 8px; padding: 8px 0; margin-top: 5px; }

        .keypad { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
        .btn-k { padding: 12px 0; font-size: 16px; font-weight: bold; border: none; border-radius: 6px; cursor: pointer; color: white; background: rgba(255,255,255,0.15); }
        .btn-k:active { transform: scale(0.95); background: rgba(255,255,255,0.3); }
        .btn-game { grid-column: span 2; background: #2e7d32; color: white; padding: 15px 0; font-size: 18px; margin-top: 5px; }
        .btn-undo { grid-column: span 2; background: #c62828; color: white; font-size: 12px; padding: 8px 0; margin-top: 5px; }

        .finish-bar { display: flex; gap: 10px; width: 100%; max-width: 500px; margin-top: 5px; }
        .btn-finish { flex: 2; background: #1b5e20; color: white; border: none; padding: 15px; border-radius: 8px; font-weight: 900; font-size: 14px; cursor: pointer; }
        .btn-wo { flex: 1; background: #b71c1c; color: white; border: none; padding: 15px; border-radius: 8px; font-weight: 900; font-size: 12px; cursor: pointer; }

        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); justify-content:center; align-items:center; z-index:9999; padding: 15px; box-sizing: border-box; }
        .modal-box { background: #1e1e1e; padding: 20px; border-radius: 8px; width: 100%; max-width: 400px; border: 1px solid #444; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
    </style>
</head>
<body>

    <div id="view-login" class="login-box">
        <h3>WASIT PRO V10.6</h3>
        <input id="inp-court" class="inp-login" placeholder="Nama Court">
        <input id="inp-pin" type="tel" class="inp-login" placeholder="PIN (Kosongi jika tidak ada)">
        <button onclick="login()" class="btn-login">MASUK</button>
    </div>

    <div id="view-dash" class="hidden" style="width:100%; display:flex; flex-direction:column; align-items:center;">
        
        <div class="timer-bar">
            <div class="t-box">
                <div class="t-lbl">MATCH TIME</div>
                <div class="t-val" id="val-timer-match">00:00</div>
                <button class="t-btn" id="btn-timer-match" style="background:#0277bd;" onclick="toggleMatchTimer()">START</button>
            </div>
            <div class="t-box">
                <div class="t-lbl" style="color:#ff9800;">REST TIME</div>
                <div class="t-val clickable" id="val-timer-rest" style="color:#ffb74d; cursor:pointer;" onclick="setCustomRestTime()" title="Klik untuk ubah waktu">02:00</div>
                <button class="t-btn" id="btn-timer-rest" style="background:#e65100;" onclick="toggleRestTimer()">START</button>
            </div>
        </div>

        <div class="ctrl-bar">
            <div class="set-nav">
                <button class="btn-nav" onclick="changeSet(-1)">&#171;</button>
                <div style="font-size:14px; font-weight:900; color:#ffd700; text-transform:uppercase;" id="lbl-court">...</div>
                <button class="btn-nav" onclick="changeSet(1)">&#187;</button>
            </div>
            
            <button class="mode-toggle" style="padding:10px 15px; background:#455a64; color:white; border:none;" onclick="openSettings()">‚öôÔ∏è</button>
            
            <button class="mode-toggle" id="btn-mode" onclick="toggleMode()">
                <div class="ind-mode" id="ind-mode"></div>
                MODE ANGKA
            </button>
        </div>
        
        <div style="font-size:12px; font-weight:bold; margin-bottom:5px;">SET <span id="lbl-set">1</span></div>
        
        <div id="smart-alert" class="smart-alert hidden"></div>

        <div class="arena">
            <div class="side team-a">
                <div style="text-align:center; font-size:10px; color:#aaa; margin-bottom:5px;">TIM A</div>
                <div class="serve-box" id="box-players-a"></div>
                <div class="score-display">
                    <div class="game-adj"><button onclick="adjGame('a', -1)">-</button><input id="game-a" class="game-val" value="0" readonly><button onclick="adjGame('a', 1)">+</button></div>
                    <input id="point-a" class="point-val" value="0" readonly>
                </div>
                <div class="keypad" id="pad-a"></div>
            </div>

            <div class="side team-b">
                <div style="text-align:center; font-size:10px; color:#aaa; margin-bottom:5px;">TIM B</div>
                <div class="serve-box" id="box-players-b"></div>
                <div class="score-display">
                    <div class="game-adj"><button onclick="adjGame('b', -1)">-</button><input id="game-b" class="game-val" value="0" readonly><button onclick="adjGame('b', 1)">+</button></div>
                    <input id="point-b" class="point-val" value="0" readonly>
                </div>
                <div class="keypad" id="pad-b"></div>
            </div>
        </div>

        <div class="finish-bar">
            <button class="btn-finish" onclick="tutupMatch()">üèÅ SELESAIKAN MATCH</button>
            <button class="btn-wo" onclick="retireMatch()">üöë WO / RETIRED</button>
        </div>

        <button onclick="location.reload()" style="margin-top:15px; background:transparent; border:none; color:#555; font-size:11px; padding:10px;">GANTI COURT / LOGOUT</button>
    </div>

    <div id="modal-settings" class="modal">
        <div class="modal-box">
            <h3 style="margin-top:0; color:#4fc3f7; text-align:center; border-bottom:1px solid #333; padding-bottom:10px;">‚öôÔ∏è PENGATURAN WASIT</h3>
            <div style="margin-bottom:15px; margin-top:20px;">
                <label style="font-size:12px; color:#aaa; display:block; margin-bottom:5px;">Sistem Perpindahan Serve:</label>
                <select id="w-serve-system" style="width:100%; padding:12px; background:#2c2c2c; color:white; border:1px solid #555; border-radius:6px; font-weight:bold; font-size:14px;">
                    <option value="classic">üéæ TENIS / PADEL (Auto-Rotasi Silang)</option>
                    <option value="manual">üéØ MANUAL BEBAS (Wasit Klik Bebas)</option>
                </select>
            </div>
            <div style="margin-bottom:30px; background:rgba(255,0,0,0.1); padding:10px; border-radius:6px; border:1px solid #b71c1c;">
                <label style="display:flex; align-items:center; gap:10px; font-size:12px; color:#ff8a80; cursor:pointer; font-weight:bold;">
                    <input type="checkbox" id="w-hide-serve" style="width:20px; height:20px;">
                    MATIKAN FITUR SERVE (Bola / Basket)
                </label>
            </div>
            <div style="display:flex; gap:10px;">
                <button onclick="closeSettings()" style="flex:1; padding:12px; background:#444; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:bold;">BATAL</button>
                <button onclick="saveSettings()" id="btn-save-settings" style="flex:2; padding:12px; background:#0288d1; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:bold;">SIMPAN</button>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://gubcvxiupehbdpigrdct.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_k1y6fNI2opEXhwqKMbGYcA__2nD0yT6';
        const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let matchId = null; let tournamentId = null; 
        let currentSet = 1; let isTieBreak = false;
        let globalServer = ''; let serveSystem = 'manual'; let hideServe = false;
        let arrPlayersA = []; let arrPlayersB = [];
        let lastServerA = ''; let lastServerB = '';
        let localMatchData = {}; // Cache data lokal untuk transisi mulus

        let matchSec = 0; let matchTimer = null;
        function toggleMatchTimer() { const btn = document.getElementById('btn-timer-match'); if(matchTimer) { clearInterval(matchTimer); matchTimer = null; btn.innerText = "RESUME"; } else { matchTimer = setInterval(()=>{ matchSec++; document.getElementById('val-timer-match').innerText = formatTime(matchSec); }, 1000); btn.innerText = "PAUSE"; } }

        let defaultRestSec = 120; let restSec = 120; let restTimer = null;
        function setCustomRestTime() { if(restTimer) return; let input = prompt("PENGATURAN WAKTU ISTIRAHAT ‚è±Ô∏è\\nMasukkan waktu dalam satuan detik.\\nContoh:\\n60 = 1 Menit\\n90 = 1.5 Menit\\n120 = 2 Menit", defaultRestSec); if(input !== null) { let parsed = parseInt(input); if(!isNaN(parsed) && parsed > 0) { defaultRestSec = parsed; restSec = defaultRestSec; document.getElementById('val-timer-rest').innerText = formatTime(restSec); } else { alert("Gagal: Masukkan angka yang valid!"); } } }
        function toggleRestTimer() { const btn = document.getElementById('btn-timer-rest'); if(restTimer) { clearInterval(restTimer); restTimer = null; btn.innerText = "START"; document.getElementById('val-timer-rest').style.color = '#ffb74d'; } else { if(restSec <= 0) restSec = defaultRestSec; document.getElementById('val-timer-rest').style.color = '#ff1744'; restTimer = setInterval(()=>{ restSec--; if(restSec <= 0) { clearInterval(restTimer); restTimer = null; btn.innerText = "START"; document.getElementById('val-timer-rest').innerText="00:00"; alert("‚è±Ô∏è WAKTU ISTIRAHAT TELAH HABIS!"); return; } document.getElementById('val-timer-rest').innerText = formatTime(restSec); }, 1000); btn.innerText = "STOP"; } }
        function formatTime(s) { let m = Math.floor(s/60); let rs = s%60; return (m<10?'0':'')+m+':'+(rs<10?'0':'')+rs; }

        function openSettings() { document.getElementById('w-serve-system').value = serveSystem; document.getElementById('w-hide-serve').checked = hideServe; document.getElementById('modal-settings').style.display = 'flex'; }
        function closeSettings() { document.getElementById('modal-settings').style.display = 'none'; }
        async function saveSettings() { const btn = document.getElementById('btn-save-settings'); btn.innerText = "MENYIMPAN..."; let newSys = document.getElementById('w-serve-system').value; let newHide = document.getElementById('w-hide-serve').checked; if (tournamentId) { await db.from('partners').update({ serve_system: newSys, hide_serve: newHide ? 'true' : 'false' }).eq('tournament_id', tournamentId); } serveSystem = newSys; hideServe = newHide; renderPlayerBoxes(); closeSettings(); btn.innerText = "SIMPAN"; alert("‚úÖ Pengaturan Berhasil Diterapkan!"); }

        async function login() {
            try {
                const btn = document.querySelector('.btn-login'); btn.innerText = "MEMUAT...";
                const c = document.getElementById('inp-court').value.trim(); const p = document.getElementById('inp-pin').value.trim();
                if(!c) { alert("‚ö†Ô∏è Nama Court Tidak Boleh Kosong!\\nContoh: valencia"); btn.innerText = "MASUK"; return; }
                const { data, error } = await db.from('matches_pro').select('*').ilike('court_name', c).eq('status', 'LIVE');
                if(error) throw error; 
                if(!data || data.length === 0) { alert("üö´ AKSES DITOLAK!\\n\\nTidak ada pertandingan yang berstatus 'LIVE' di court " + c.toUpperCase() + "."); btn.innerText = "MASUK"; return; }
                const matchData = data[0];
                let dbPin = matchData.pin ? String(matchData.pin).trim() : "";
                if(dbPin !== "" && dbPin !== p) { alert("‚ùå PIN SALAH!"); btn.innerText = "MASUK"; return; }
                let sSys = 'manual'; let hServe = false;
                if (matchData.tournament_id) { tournamentId = matchData.tournament_id; const { data: pData } = await db.from('partners').select('*').eq('tournament_id', tournamentId).maybeSingle(); if(pData) { sSys = pData.serve_system || 'manual'; hServe = (pData.hide_serve === 'true'); } }
                serveSystem = sSys; hideServe = hServe; matchId = matchData.id; document.getElementById('lbl-court').innerText = matchData.court_name; loadMatch(matchData);
            } catch (err) { alert("üö® CRASH SISTEM!\\nPesan Error: " + err.message); document.querySelector('.btn-login').innerText = "MASUK"; }
        }

        function loadMatch(m) {
            document.getElementById('view-login').classList.add('hidden'); document.getElementById('view-dash').classList.remove('hidden');
            localMatchData = m;
            currentSet = m.current_set || 1; globalServer = m.server || '';
            let rawTeamA = m.team_a || "Tim A"; let rawTeamB = m.team_b || "Tim B";
            arrPlayersA = rawTeamA.includes('/') ? rawTeamA.split('/').map(x=>x.trim()) : [rawTeamA]; arrPlayersB = rawTeamB.includes('/') ? rawTeamB.split('/').map(x=>x.trim()) : [rawTeamB];
            if (!lastServerA && arrPlayersA.length > 0) lastServerA = arrPlayersA[0]; if (!lastServerB && arrPlayersB.length > 0) lastServerB = arrPlayersB[0];
            if (arrPlayersA.includes(globalServer)) lastServerA = globalServer; if (arrPlayersB.includes(globalServer)) lastServerB = globalServer;
            renderPlayerBoxes(); renderScores(m); renderButtons(); subscribeMatch();
        }

        function renderPlayerBoxes() {
            const boxA = document.getElementById('box-players-a'); const boxB = document.getElementById('box-players-b');
            let htmlA = ''; arrPlayersA.forEach(p => { let isAct = (globalServer === p || globalServer === 'a') && !hideServe; let actCls = isAct ? 'active' : ''; let clickEv = hideServe ? '' : `onclick="setServer('${p}')"`; let ball = hideServe ? '' : `<span class="ball-icon">üéæ</span>`; htmlA += `<div class="player-row ${actCls}" ${clickEv}><span>${p}</span>${ball}</div>`; }); boxA.innerHTML = htmlA;
            let htmlB = ''; arrPlayersB.forEach(p => { let isAct = (globalServer === p || globalServer === 'b') && !hideServe; let actCls = isAct ? 'active' : ''; let clickEv = hideServe ? '' : `onclick="setServer('${p}')"`; let ball = hideServe ? '' : `<span class="ball-icon">üéæ</span>`; htmlB += `<div class="player-row ${actCls}" ${clickEv}><span>${p}</span>${ball}</div>`; }); boxB.innerHTML = htmlB;
        }

        async function setServer(playerName) { if(hideServe) return; globalServer = playerName; if (arrPlayersA.includes(globalServer)) lastServerA = globalServer; if (arrPlayersB.includes(globalServer)) lastServerB = globalServer; renderPlayerBoxes(); await db.from('matches_pro').update({ server: playerName }).eq('id', matchId); }

        function toggleMode() { isTieBreak = !isTieBreak; const btn = document.getElementById('btn-mode'); const ind = document.getElementById('ind-mode'); if(isTieBreak) { btn.classList.add('active'); ind.style.background = 'white'; document.body.classList.add('mode-tb'); } else { btn.classList.remove('active'); ind.style.background = '#555'; document.body.classList.remove('mode-tb'); } renderButtons(); }

        function renderButtons() {
            const padA = document.getElementById('pad-a'); const padB = document.getElementById('pad-b'); let html = "";
            if(isTieBreak) { html = `<button class="btn-k" style="background:rgba(255,255,255,0.05);" onclick="addPt('TARGET', -1)">-1</button><button class="btn-k" onclick="addPt('TARGET', 1)">+1</button><button class="btn-k btn-game" onclick="winGame('TARGET')">MENANG SET</button><button class="btn-k btn-undo" onclick="resetPoint()">RESET POIN</button>`; } 
            else { html = `<button class="btn-k" onclick="setPt('TARGET', '15')">15</button><button class="btn-k" onclick="setPt('TARGET', '30')">30</button><button class="btn-k" onclick="setPt('TARGET', '40')">40</button><button class="btn-k" onclick="setPt('TARGET', 'AD')">AD</button><button class="btn-k btn-game" onclick="winGame('TARGET')">GAME</button><button class="btn-k btn-undo" onclick="resetPoint()">RESET POIN 0-0</button>`; }
            padA.innerHTML = html.replaceAll('TARGET', 'a'); padB.innerHTML = html.replaceAll('TARGET', 'b');
        }

        function checkAlerts(ptA, ptB) {
            const alertEl = document.getElementById('smart-alert'); if(isTieBreak) { alertEl.classList.add('hidden'); return; }
            if((ptA === '40' && ptB === '40') || (ptA === 'AD' || ptB === 'AD')) { alertEl.innerHTML = "üî• DEUCE / GOLDEN POINT"; alertEl.style.background = "#c62828"; alertEl.style.color = "white"; alertEl.classList.remove('hidden'); } else if ((ptA === '40' && ptB !== '40') || (ptB === '40' && ptA !== '40')) { alertEl.innerHTML = "‚ö†Ô∏è GAME POINT / BREAK POINT"; alertEl.style.background = "#fbc02d"; alertEl.style.color = "black"; alertEl.classList.remove('hidden'); } else { alertEl.classList.add('hidden'); }
        }

        function renderScores(m) { 
            localMatchData = m;
            document.getElementById('lbl-set').innerText = currentSet; 
            document.getElementById('game-a').value = m[`set${currentSet}_a`] || 0; 
            document.getElementById('game-b').value = m[`set${currentSet}_b`] || 0; 
            document.getElementById('point-a').value = m.points_a || '0'; 
            document.getElementById('point-b').value = m.points_b || '0'; 
            checkAlerts(m.points_a, m.points_b); 
            if(m.server && !hideServe) { globalServer = m.server; renderPlayerBoxes(); } 
        }

        async function setPt(team, val) { document.getElementById('point-'+team).value = val; let otherTeam = team==='a'?'b':'a'; checkAlerts(val, document.getElementById('point-'+otherTeam).value); await db.from('matches_pro').update({ [`points_${team}`]: val }).eq('id', matchId); }
        async function addPt(team, delta) { const el = document.getElementById('point-'+team); let now = parseInt(el.value); if(isNaN(now)) now = 0; let next = now + delta; if(next < 0) next = 0; el.value = next; await db.from('matches_pro').update({ [`points_${team}`]: next }).eq('id', matchId); }
        async function resetPoint() { if(!confirm("Kembalikan Poin ke 0-0?")) return; document.getElementById('point-a').value = '0'; document.getElementById('point-b').value = '0'; checkAlerts('0', '0'); await db.from('matches_pro').update({ points_a: '0', points_b: '0' }).eq('id', matchId); }

        async function winGame(team) {
            if(!confirm("Tim ini memenangkan Game?")) return;
            const fieldGame = `set${currentSet}_${team}`; const elGame = document.getElementById('game-'+team); let val = parseInt(elGame.value) + 1; elGame.value = val;
            let nextServer = globalServer; 
            if(serveSystem === 'classic' && !hideServe) {
                let currentTeam = arrPlayersA.includes(globalServer) ? 'A' : (arrPlayersB.includes(globalServer) ? 'B' : '');
                if (currentTeam === 'A') { if (arrPlayersB.length === 2) { nextServer = (lastServerB === arrPlayersB[0]) ? arrPlayersB[1] : arrPlayersB[0]; } else { nextServer = arrPlayersB[0] || 'b'; } } 
                else if (currentTeam === 'B') { if (arrPlayersA.length === 2) { nextServer = (lastServerA === arrPlayersA[0]) ? arrPlayersA[1] : arrPlayersA[0]; } else { nextServer = arrPlayersA[0] || 'a'; } }
            }
            globalServer = nextServer; if (arrPlayersA.includes(globalServer)) lastServerA = globalServer; if (arrPlayersB.includes(globalServer)) lastServerB = globalServer;
            if(!hideServe) renderPlayerBoxes(); document.getElementById('point-a').value = '0'; document.getElementById('point-b').value = '0'; checkAlerts('0', '0');
            await db.from('matches_pro').update({ [fieldGame]: val, points_a: '0', points_b: '0', server: nextServer }).eq('id', matchId);
        }

        async function adjGame(team, delta) { const field = `set${currentSet}_${team}`; const el = document.getElementById('game-'+team); let val = parseInt(el.value) + delta; if(val < 0) val = 0; el.value = val; await db.from('matches_pro').update({ [field]: val }).eq('id', matchId); }
        
        // üí° PERBAIKAN PINDAH SET (RESPONSIF LOKAL + ERROR HANDLING)
        async function changeSet(delta) { 
            const next = currentSet + delta; 
            if(next < 1 || next > 5) return; 
            if(!confirm(`Pindah ke SET ${next}? Poin akan direset 0-0.`)) return; 
            
            // 1. Update UI Lokal agar instan!
            currentSet = next; 
            document.getElementById('lbl-set').innerText = currentSet;
            document.getElementById('game-a').value = localMatchData[`set${currentSet}_a`] || 0;
            document.getElementById('game-b').value = localMatchData[`set${currentSet}_b`] || 0;
            document.getElementById('point-a').value = '0';
            document.getElementById('point-b').value = '0';
            checkAlerts('0', '0'); 
            
            // 2. Eksekusi ke Supabase
            const {error} = await db.from('matches_pro').update({ current_set: next, points_a:'0', points_b:'0' }).eq('id', matchId); 
            if (error) { alert("üö® Gagal Pindah Set!\nPastikan Anda SUDAH MEMBUAT kolom 'current_set' (tipe int4) di tabel matches_pro Supabase.\nPesan Error: " + error.message); }
        }

        async function tutupMatch() { if(!confirm("Anda yakin Pertandingan ini sudah SELESAI?\\nStatus di Control Panel akan otomatis berubah menjadi FINISHED.")) return; await db.from('matches_pro').update({ status: 'FINISHED' }).eq('id', matchId); alert("Match Berhasil Diselesaikan! Terima kasih."); location.reload(); }
        async function retireMatch() { if(!confirm("Tandai ada tim yang WALKOVER / RETIRED?\\nIni akan mengakhiri match secara otomatis.")) return; await db.from('matches_pro').update({ status: 'FINISHED', is_wo: true }).eq('id', matchId); alert("Match ditandai WO/Retired."); location.reload(); }

        function subscribeMatch() { db.channel('room-'+matchId).on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'matches_pro', filter: `id=eq.${matchId}` }, (payload) => { const m = payload.new; if(m.status !== 'LIVE') location.reload(); currentSet = m.current_set || 1; renderScores(m); }).subscribe(); }
    </script>
</body>
</html>